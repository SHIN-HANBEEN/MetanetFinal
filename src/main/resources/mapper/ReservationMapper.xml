<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="metanet.kosa.metanetfinal.reservation.repository.IReservationRepository">
	<insert id="insertReservationData"
		parameterType="metanet.kosa.metanetfinal.reservation.model.Reservations">
		INSERT INTO RESERVATIONS
		(RES_ID, MEMBER_ID, PHONE_NUM, ROUTE_ID,
		BUS_ID, SEAT_ID, DISCOUNT_ID, RES_DATE, PAY_ID, TOTAL_PRICE,
		CANCLED_DATE)
		VALUES
		(res_id.NEXTVAL,
		<if test="res.memberId == 0">
			null
		</if>
		<if test="res.memberId gte 1">
			#{res.memberId}
		</if>
		, #{res.phoneNum}, #{res.routeId}, #{res.busId}, #{res.seatId},
		#{res.discountId},
		#{res.resDate}, #{res.payId}, #{res.totalPrice},
		<if test="res.cancledDate == null">
			null
		</if>
		<if test="res.cancledDate != null">
			#{res.cancledDate}
		</if>
		)
	</insert>

	<select id="getReservationHistoryNotUsed"
		resultType="metanet.kosa.metanetfinal.reservation.model.DetailedReservation">
    <![CDATA[
    SELECT
        LISTAGG(res.seat_id, ' , ') WITHIN GROUP (ORDER BY res.seat_id) AS seatIds,
        dt.terminal_name AS departureTerminalName,
        at.terminal_name AS arrivalTerminalName,
        r.DEPARTURE_TIME AS departureTime,
        r.arrival_time AS arrivalTime,
        res.res_date AS resDate,
        res.pay_id as payId,
        res.total_price as totalPrice
    FROM
        reservations res
    JOIN
        routes r ON res.route_id = r.route_id
    JOIN
        terminals dt ON r.departure_id = dt.terminal_id
    JOIN
        terminals at ON r.arrival_id = at.terminal_id
    WHERE
        res.phone_num = #{phoneNum} 
        and r.DEPARTURE_TIME >= sysdate
        AND res.cancled_date IS NULL
    GROUP BY
        res.pay_id, r.route_id, r.departure_id, dt.terminal_name, r.arrival_id,
        at.terminal_name, r.DEPARTURE_TIME, r.arrival_time, res.res_date, res.total_price
    ORDER BY
        res.res_date
    ]]>
</select>

	<select id="getReservationHistoryForLastSixMonth"
		resultType="metanet.kosa.metanetfinal.reservation.model.DetailedReservation">
    SELECT
        LISTAGG(res.seat_id, ' , ') WITHIN GROUP (ORDER BY res.seat_id) AS seatIds,
        dt.terminal_name AS departureTerminalName,
        at.terminal_name AS arrivalTerminalName,
        r.DEPARTURE_TIME AS departureTime,
        r.arrival_time AS arrivalTime,
        res.res_date AS resDate,
        res.pay_id as payId,
        res.total_price as totalPrice
    FROM
        reservations res
    JOIN
        routes r ON res.route_id = r.route_id
    JOIN
        terminals dt ON r.departure_id = dt.terminal_id
    JOIN
        terminals at ON r.arrival_id = at.terminal_id
    WHERE
        res.phone_num = #{phoneNum}
         <if test="canceledDate">
        AND res.cancled_date IS NOT NULL
		    </if>
		    <if test="!canceledDate">
		    AND res.cancled_date IS NULL
		    </if> 
        and res.res_date >= ADD_MONTHS(SYSDATE, -6)
    GROUP BY
        res.pay_id, r.route_id, r.departure_id, dt.terminal_name, r.arrival_id,
        at.terminal_name, r.DEPARTURE_TIME, r.arrival_time, res.res_date, res.total_price
    ORDER BY
        res.res_date
</select>

	<select id="testCount">
		select count(*) from reservations
	</select>
</mapper>