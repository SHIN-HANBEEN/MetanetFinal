<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Hello, world!</title>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<!--     Fonts and icons     -->
	<link rel="stylesheet" type="text/css"
		href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
	<!-- Nucleo Icons -->
	<link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
	<link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
	<!-- Font Awesome Icons -->
	<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
	<!-- Material Icons -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
	<!-- Material Kit CSS -->
	<!--<link href="./assets/css/material-kit.css?v=3.0.0" rel="stylesheet" />-->
	<link href="../assets/css/material-kit.css?v=3.0.0" rel="stylesheet" />

	<!-- 커스텀 CSS -->
	<link href="../assets/css/final.css" rel="stylesheet" />
</head>

<body>
	<div th:replace="~{fragments/navbarFragment :: navbar}"></div>
	<!-- Include navbar fragment -->

	<!-- container fluid -->
	<div class="container-fluid">
		<div class="row">
			<div class="col-lg-12 metanet-page-header" style="height: 100vh; background-image: url('./assets/img/bus.png');">
				<span class="mask bg-gradient-dark opacity-6"></span>
				<div class="container-fluid my-11">

					<div class="container my-auto">
						<div class="row">
							<div class="col-lg-4 col-md-8 col-12 mx-auto">
								<div class="card z-index-0 fadeIn3 fadeInBottom">
									<div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
										<div class="bg-gradient-primary shadow-primary border-radius-lg py-3 pe-1">
											<h4 class="text-white font-weight-bolder text-center mt-2 mb-0">로그인</h4>
											<div class="row mt-3">
												<div class="col-2 text-center ms-auto">
													<a class="btn btn-link px-3" href="javascript:;">
														<i class="fa fa-facebook text-white text-lg"></i>
													</a>
												</div>
												<div class="col-2 text-center px-1">
													<a class="btn btn-link px-3" href="javascript:;">
														<i class="fa fa-github text-white text-lg"></i>
													</a>
												</div>
												<div class="col-2 text-center me-auto">
													<a class="btn btn-link px-3" href="javascript:;">
														<i class="fa fa-google text-white text-lg"></i>
													</a>
												</div>
											</div>
										</div>
									</div>
									<div class="card-body">
										<form role="form" action="/login" method="post" class="text-start" id="loginForm"
											onsubmit="submitForm(event)">
											<div class="input-group input-group-outline my-3">
												<label class="form-label">아이디</label>
												<input type="text" class="form-control" id="id" name="id" autocomplete="off">
											</div>
											<div class="input-group input-group-outline mb-3">
												<label class="form-label">비밀번호</label>
												<input type="password" class="form-control" id="password" name="password" autocomplete="off">
											</div>

											<div class="form-check form-switch d-flex align-items-center mb-3">
												<input class="form-check-input" type="checkbox" id="rememberMe" checked>
												<label class="form-check-label mb-0 ms-3" for="rememberMe">아이디
													저장</label>
											</div>
											<div class="text-center">
												<button type="submit" class="btn bg-gradient-primary w-100 my-2 mb-2">로그인</button>
											</div>

											<p class="mt-4 text-sm text-center">
												아직 가입하지 않으셨나요?
											</p>

										</form>
										<div class="text-center">
											<a href="signin" class="btn bg-gradient-primary w-100 my-1 mb-2">
												회원가입
											</a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

			</div>
		</div>


	</div>
	</div>
	</div>

	<!-- footer -->
	<!-- Include footer fragment -->
	<div th:replace="~{fragments/footerFragment :: footer}"></div>


	<!--입력한 폼을 검증 후 JWT 토큰을 발급 받아 sessionStorage에 저장-->
	<script>

		async function submitForm(event) {
			event.preventDefault();

			try {
				const formData = new FormData(document.getElementById('loginForm'));
				const response = await fetch('/login', {
					method: 'POST',
					body: formData
				});

				if (response.ok) {
					// Get the token from the response body
					const token = await response.text();
					console.log("로그인 토큰 : " + token);

					// Save the token in local storage
					window.localStorage.setItem('X-AUTH-TOKEN', token);

					//localStorage 에서 token 꺼내기
					/*const localToken = window.localStorage.getItem('X-Auth-Token');
					console.log("login 페이지에서 localStorage 토큰꺼내기 : " + localToken);*/

					const localToken = token;

					// Check if the token is present
					if (localToken) {
						// 홈디렉토리
						const apiUrl = '/';

						const xhr = new XMLHttpRequest();
						xhr.open('GET', apiUrl, true);
						xhr.setRequestHeader('X-AUTH-TOKEN', `${localToken}`);
						xhr.setRequestHeader('Content-Type', 'application/json');

						// Set up event listeners for handling the response
						xhr.onload = function () {
							if (xhr.status >= 200 && xhr.status < 300) {
								// Success logic
								console.log('Login 에서 Home XHR Request successful');
								// Add the logic to redirect here
								window.location.href = '/'; // Adjust the path as needed
							} else {
								// Error handling logic
								console.error('Failed to make the request. Status:', xhr.status);
							}
						};

						xhr.onerror = function () {
							// Error handling logic
							console.error('Network error occurred');
						};

						console.log("login 에서 xhr send 보내기 직전");
						// Send the request
						xhr.send();

					} else {
						// Handle the case where the token is not present
						console.error('Token not found in local storage.');
					}
				} else {
					alert("아이디 또는 비밀번호가 틀렸습니다.");
				}
			} catch (error) {
				console.error('Error:', error.message);
			}


		}

	</script>
	<!--   Core JS Files   -->
	<script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
	<script src="./assets/js/core/bootstrap.min.js" type="text/javascript"></script>
	<script src="./assets/js/plugins/perfect-scrollbar.min.js"></script>
	<!--  Plugin for TypedJS, full documentation here: https://github.com/inorganik/CountUp.js -->
	<script src="./assets/js/plugins/countup.min.js"></script>
	<script src="./assets/js/plugins/choices.min.js"></script>
	<script src="./assets/js/plugins/prism.min.js"></script>
	<script src="./assets/js/plugins/highlight.min.js"></script>
	<!--  Plugin for Parallax, full documentation here: https://github.com/dixonandmoe/rellax -->
	<script src="./assets/js/plugins/rellax.min.js"></script>
	<!--  Plugin for TiltJS, full documentation here: https://gijsroge.github.io/tilt.js/ -->
	<script src="./assets/js/plugins/tilt.min.js"></script>
	<!--  Plugin for Selectpicker - ChoicesJS, full documentation here: https://github.com/jshjohnson/Choices -->
	<script src="./assets/js/plugins/choices.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTTfWur0PDbZWPr7Pmq8K3jiDp0_xUziI"></script>
	<script src="./assets/js/material-kit.min.js?v=3.0.4" type="text/javascript"></script>
</body>

</html>