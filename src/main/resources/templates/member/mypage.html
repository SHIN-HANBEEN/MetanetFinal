<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
	<link rel="icon" href="/assets/busFavicon.png" type="image/png">
	<title>
		MetaBus
	</title>
	<!--     Fonts and icons     -->
	<link rel="stylesheet" type="text/css"
		href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
	<!-- Nucleo Icons -->
	<link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
	<link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
	<!-- Font Awesome Icons -->
	<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

	<!-- Material Icons -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
	<!-- CSS Files -->
	<link id="pagestyle" href="../assets/css/material-kit.css?v=3.0.4" rel="stylesheet" />
	<!-- 커스텀 CSS -->
	<link href="../assets/css/final.css" rel="stylesheet" />
	<!-- Nepcha Analytics (nepcha.com) -->
	<!-- Nepcha is a easy-to-use web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. -->
	<script defer data-site="YOUR_DOMAIN_HERE" src="https://api.nepcha.com/js/nepcha-analytics.js"></script>
</head>

<body class="about-us bg-gray-200">
	<!-- Navbar Transparent -->
	<div th:replace="~{fragments/navbarFragment :: navbar}"></div>

	<!-- End Navbar -->
	<!--  START HEADER 7 w/ text and video -->
	<header class="bg-gradient-dark">
		<div class="page-header min-vh-100" style="background-image: url('../assets/img/bg9.jpg'); max-height: 100%;">
			<span class="mask bg-gradient-dark opacity-6"></span>
			<div class="container">
				<div class="row justify-content-center">
					<div class="col-lg-8 text-center mx-auto my-auto">
						<h1 class="text-white mb-8">마이페이지</h1>

					</div>
					<div class="row">
						<div class="col-lg-5 text-center">
							<div class="col-lg-12 card move-on-hover mt-4 ">
								<a href="/reservation/list">
									<div class="row">
										<div class="col-lg-10 col-md-10 offset-lg-1 card-body ps-lg-0;" style="min-height: 300px;">
											<div class="card-body ps-lg-0">
												<h4 class="mb-0">예매 정보</h4><br />
												<div class="row">
													<div class="col-lg-10 col-md-10"
														style="display: inline-block; text-align: left; font-size: 20px;">
														<span class="text-info">사용가능 예매 수 :
															<span class="text-info" th:text="${countNotUserdList}"></span>
															<span>건</span>
														</span><br />
														<span class="text-info">전체 예매 수 :
															<span class="text-info" th:text="${countResList}"></span>
															<span>건</span>
														</span><br /><br />
														<span>> 예매 정보 확인하러 가기</span>

													</div>
												</div>
											</div>
										</div>
									</div>
								</a>
							</div>
						</div>


						<div class="col-lg-7 text-center">
							<div class="col-lg-12 card move-on-hover mt-4">
								<a href="/member-information">



									<div class="row">

										<div class="col-lg-10 col-md-10 offset-lg-1 card-body ps-lg-0" style="min-height: 300px;">

											<div class="card-body ps-lg-0">
												<h4 class="mb-0">회원 정보</h4><br />
												<table class="table table-hover table-bordered" id="notuserdreservationtable">

													<tr>
														<th>이름</th>
														<th>이메일</th>
														<th>생년월일</th>
														<th>마일리지</th>
													</tr>
													<tr class="clickable-row" data-toggle="modal" data-target="#reservationModal"
														data-reservation-id="${res.id}" style="cursor: pointer;">
														<td th:text="${member.name}">출발지</td>
														<td th:text="${member.email}">도착지</td>
														<td th:text="${member.birthDate}">출발시간</td>
														<td th:text="${member.mileage}">도착시간</td>
													</tr>
												</table>
												<span style="display: inline-block; text-align: left; font-size: 20px;">> 회원상세정보</span>

								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>
	<!-- -------- END HEADER 7 w/ text and video ------- -->
	
	

	<div class="modal fade" id="reservationModal" tabindex="-1" role="dialog" aria-labelledby="reservationModalLabel"
		aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="reservationModalLabel">예약 상세 정보</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- 모달 내용을 표시할 위치 -->
					<div>
						<div class="rounded-4 border border-4 border-success m-4 p-4">
							<p class="fs-3 fw-bold text-body-emphasis">탑승일&nbsp;&nbsp;<span id="modalDepDate"></span></p>
							<div class="fs-4 text-success fw-semibold">
								<i class="bi bi-geo-alt"></i>&nbsp;승차
								<p class="fs-5 fw-semibold"><span id="modalDepartureTerminal" class="text-body-emphasis"></span><br>
									<span id="modalDepartureTime" class="text-body-emphasis"></span></p>
								<i class="bi bi-geo-alt"></i>&nbsp;하차
								<p class="fs-5 fw-semibold"><span id="modalArrivalTerminal" class="text-body-emphasis"></span><br>
									<span id="modalArrivalTime" class="text-body-emphasis"></span></p>
							</div>
							<div class="border-top border-secondary fs-5 fw-bold text-body-emphasis">
								<p class="fs-4 text-success fw-semibold">좌석<br>
									<span id="modalSeatIds" class="fs-5 fw-semibold text-body-emphasis"></span></p>
								<p class="fs-4 text-success fw-semibold">결제금액<br>
									<span id="modalTotalPrice" class="fs-5 fw-semibold text-body-emphasis"></span><span class="text-body-emphasis">원</span></p>
								<br>
								<p class="fs-5 fw-semibold text-body-emphasis">예약일시 &nbsp; <span id="modalResDate"></span></p>
							</div>
							<!-- <p>결제 번호: <span id="modalPayId"></span></p>
							<p>출발 ID: <span id="modaldepartureTerminalId"></span></p>
							<p>도착 ID: <span id="modalarrivalTerminalId"></span></p> -->
						</div>
					</div>
				</div>
				<div class="modal-footer fs-6">
					
					<button type="button" class="btn btn-outline-info fs-6" id="ticketPrint">티켓출력</button>
					<button type="button" class="btn btn-outline-info fs-6" id='changeSeat'>좌석변경</button>
					<button type="button" class="btn btn-outline-danger fs-6" id="deleteButton" style="float: left;">예매취소</button>
					<button type="button" class="btn btn-outline-secondary fs-6" data-bs-dismiss="modal">닫기</button>

				</div>
			</div>
		</div>
	</div>

	<div th:replace="~{fragments/footerFragment :: footer}"></div>

	<!--   Core JS Files   -->
	<script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
	<script src="../assets/js/core/bootstrap.min.js" type="text/javascript"></script>
	<script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
	<!--  Plugin for TypedJS, full documentation here: https://github.com/inorganik/CountUp.js -->
	<script src="../assets/js/plugins/countup.min.js"></script>
	<!-- Control Center for Material UI Kit: parallax effects, scripts for the example pages etc -->
	<!--  Google Maps Plugin    -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTTfWur0PDbZWPr7Pmq8K3jiDp0_xUziI"></script>
	<script src="../assets/js/material-kit.min.js?v=3.0.4" type="text/javascript"></script>
	
	<!--sweetalert2-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>

	<script>
		var inputData;
		var depPlaceNm;
		var arrPlaceNm;
		var depTime;
		var paymentId;

		$('.clickable-row').click(function () {
			var departureTerminal = $(this).find('td:eq(0)').text();
			var arrivalTerminal = $(this).find('td:eq(1)').text();
			var departureTime = $(this).find('td:eq(2)').text().substring(0,16);
			var arrivalTime = $(this).find('td:eq(3)').text().substring(0,16);
			var resDate = $(this).find('td:eq(6)').text();
			var seatIds = $(this).find('td:eq(4)').text();
			var totalPrice = $(this).find('td:eq(5)').text();
			var payId = $(this).find('td:eq(7)').text();
			var departureTerminalId = $(this).find('td:eq(8)').text();
			var arrivalTerminalId = $(this).find('td:eq(9)').text();
			paymentId = payId;
			depPlaceNm =  departureTerminal;
			arrPlaceNm =  arrivalTerminal;
			depTime =  encodeURIComponent(departureTime);
			console.log(depTime);
			inputData = {"payId": payId, "totalPrice": totalPrice};
			console.log(depPlaceNm);
			// 모달에 데이터 넣기
			$('#modalDepartureTerminal').text(departureTerminal);
			$('#modalArrivalTerminal').text(arrivalTerminal);
			$('#modalDepDate').text(departureTime.substring(0,10));
			$('#modalDepartureTime').text(departureTime.substring(11,16));
			$('#modalArrivalTime').text(arrivalTime.substring(11,16));
			$('#modalResDate').text(resDate);
			$('#modalSeatIds').text(seatIds);
			$('#modalTotalPrice').text(totalPrice.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
			$('#modalPayId').text(payId);
			$('#modaldepartureTerminalId').text(departureTerminalId);
			$('#modalarrivalTerminalId').text(arrivalTerminalId);

			// 모달 열기
			$('#reservationModal').modal('show');
		});
		//var seatURI = '/reservation/seat-selection?dpTerminalName='+ depPlaceNm + 'arrTerminalName=' +arrPlaceNm+ 'departureTime=' + depTime;
		//var seatURI = "/reservation/seat-selection?dpTerminalName=";
		$("#changeSeat").click(function () {
			var seatURI = '/reservation/seats-selection/modification/?dpTerminalName='+ depPlaceNm + 
			'&arrTerminalName=' +arrPlaceNm+ '&departureTime=' + depTime +'&payId=' +paymentId;

			console.log(depPlaceNm);
			window.location.href = seatURI;
			//window.location.href = "/"
		});
		$("#ticketPrint").click(function () {
			var ticketURI = '/reservation/ticket?payId=' + paymentId;
			window.location.href = ticketURI;
		});
		$("#deleteButton").click(function () {
			// SweetAlert2가 나타날 때 모달 숨기기
			$("#reservationModal").modal('hide');

			Swal.fire({
				title: '예매를 취소하시겠습니까?',
				text: "한번 취소한 예매는 다시 되돌릴 수 없습니다.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: '승인',
				cancelButtonText: '취소',
				reverseButtons: true, // 버튼 순서 거꾸로
			}).then((result) => {
				if (result.isConfirmed) {

					$.ajax({
						url: '/cancelReservation',
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(inputData),
						success: function (response) {
							// 서버 응답에 대한 처리
							console.log(response);

							// SweetAlert2를 다시 표시
							Swal.fire({
								title: '시외버스 예매취소가 완료되었습니다.',
								text: '시외버스 예매취소가 완료되었습니다.',

								icon: 'success',
								confirmButtonText: '확인',
							}).then((result) => {
								if (result.isConfirmed) {
									//location.href("/mypage");
									location.reload(true);
								}
							});
							
						},
						error: function (error) {
							// 오류 발생 시 처리
							console.error(error);

							// 오류가 발생했을 때도 SweetAlert2를 다시 표시
							Swal.fire({
								title: '취소에 실패하였습니다.',
								text: '',
								icon: 'success',
								confirmButtonText: '확인',
							}).then(() => {
								location.href("/");
							});
						}
					});
				} else if (result.isDismissed && result.dismiss === Swal.DismissReason.cancel) {
					// SweetAlert2에서 "취소" 버튼 클릭 시 모달 다시 표시
					$("#reservationModal").modal('show');
				}
			});
		});

	</script>

	<!--<script>
    // 클릭한 행의 데이터를 모달에 표시하는 JavaScript 코드
    $('.clickable-row').click(function() {
        var modalContent = $(this).html();
        $('#modalContent').html(modalContent);
        $('#reservationModal').modal('show');
    });
</script>-->
	<script>
	</script>
	<script>
	
		

		

		</script>
	
</body>

</html>