<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
	<link rel="icon" type="image/png" href="../assets/img/favicon.png">
	<title>
		메타버스 마이페이지
	</title>
	<!--     Fonts and icons     -->
	<link rel="stylesheet" type="text/css"
		href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
	<!-- Nucleo Icons -->
	<link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
	<link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
	<!-- Font Awesome Icons -->
	<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

	<!-- Material Icons -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
	<!-- CSS Files -->
	<link id="pagestyle" href="../assets/css/material-kit.css?v=3.0.4" rel="stylesheet" />
	<!-- 커스텀 CSS -->
	<link href="../assets/css/final.css" rel="stylesheet" />
	<!-- Nepcha Analytics (nepcha.com) -->
	<!-- Nepcha is a easy-to-use web analytics. No cookies and fully compliant with GDPR, CCPA and PECR. -->
	<script defer data-site="YOUR_DOMAIN_HERE" src="https://api.nepcha.com/js/nepcha-analytics.js"></script>
</head>

<body class="about-us bg-gray-200">
	<!-- Navbar Transparent -->
	<div th:replace="~{fragments/navbarFragment :: navbar}"></div>

	<!-- End Navbar -->
	<!-- -------- START HEADER 7 w/ text and video ------- -->
	<header class="bg-gradient-dark">
		<div class="page-header min-vh-75" style="background-image: url('../assets/img/bg9.jpg');">
			<span class="mask bg-gradient-dark opacity-6"></span>
			<div class="container">
				<div class="row justify-content-center">
					<div class="col-lg-8 text-center mx-auto my-auto">
						<h1 class="text-white">마이페이지</h1>

					</div>
					<div class="row">
						<div class="col-lg-5 text-center">
							<div class="col-lg-12 card move-on-hover mt-4">
								<a href="#res">
									<div class="row">

										<div class="col-lg-10 col-md-10 offset-lg-1 card-body ps-lg-0;" style="min-height: 300px;">

											<div class="card-body ps-lg-0">
												<h4 class="mb-0">예매 정보</h4><br />
												<div class="row">
													<div class="col-lg-10 col-md-10"
														style="display: inline-block; text-align: left; font-size: 20px;">
														<span class="text-info">현재 예매 중인 상품 수 :
															<span class="text-info" th:text="${countNotUserdList}"></span>
															<span>건</span>
														</span><br />
														<span class="text-info">전체 예매 상품 수 :
															<span class="text-info" th:text="${countResList}"></span>
															<span>건</span>
														</span><br /><br />
														<span>예매 정보 확인하러 가기 ></span>

													</div>
												</div>
											</div>
										</div>
									</div>
								</a>
							</div>
						</div>


						<div class="col-lg-7 text-center">
							<div class="col-lg-12 card move-on-hover mt-4">
								<a href="/member-information">



									<div class="row">

										<div class="col-lg-10 col-md-10 offset-lg-1 card-body ps-lg-0" style="min-height: 300px;">

											<div class="card-body ps-lg-0">
												<h4 class="mb-0">회원 정보</h4><br />
												<table class="table table-hover table-bordered" id="notuserdreservationtable">

													<tr>
														<th>이름</th>
														<th>이메일</th>
														<th>생년월일</th>
														<th>마일리지</th>
													</tr>
													<tr class="clickable-row" data-toggle="modal" data-target="#reservationModal"
														data-reservation-id="${res.id}" style="cursor: pointer;">
														<td th:text="${member.name}">출발지</td>
														<td th:text="${member.email}">도착지</td>
														<td th:text="${member.birthDate}">출발시간</td>
														<td th:text="${member.mileage}">도착시간</td>
													</tr>
												</table>
												<span style="display: inline-block; text-align: left; font-size: 20px;">>예매 정보 확인하러 가기 ></span>

								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>
	<!-- -------- END HEADER 7 w/ text and video ------- -->
	<div id="res" class="card card-body py-1 shadow-xl mx-3 mx-md-4 mt-n6">
		<!-- Section with four info areas left & one card right with image and waves -->
		<section class="py-5" style="min-height: 100vh;">
			<div class="container">
				<div class="row">
					<div class="col-md-8 text-start mb-5 mt-5">
						<h2 class="text-black z-index-1 position-relative"> 예매 정보 조회</h2>
					</div>
				</div>
				<ul class="nav nav-tabs" id="myTab" role="tablist">
					<li class="col-lg-4 nav-item" role="presentation">
						<button class="nav-link active" id="userinfo-tab" data-bs-toggle="tab" data-bs-target="#userinfo"
							type="button" role="tab" aria-controls="userinfo" aria-selected="true">현재 예매 내역</button>
					</li>
					<li class="col-lg-4 nav-item" role="presentation">
						<button class="nav-link" id="myreview-tab" data-bs-toggle="tab" data-bs-target="#myreview" type="button"
							role="tab" aria-controls="myreview" aria-selected="false">예매 내역 조회</button>
					</li>
					<li class="col-lg-4 nav-item" role="presentation">
						<button class="nav-link" id="wishlist-tab" data-bs-toggle="tab" data-bs-target="#wishlist" type="button"
							role="tab" aria-controls="wishlist" aria-selected="false">취소 내역 조회</button>
					</li>
				</ul>

				<!-- 현재 예매 내역 -->
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade show active mb-4" id="userinfo" role="tabpanel" aria-labelledby="userinfo-tab">
						<h3 class="mt-4">예매 중인 내역</h3>

						<div th:if="${not #lists.isEmpty(ReservationNotUsedList)}">

							<table class="table table-hover table-bordered" id="notuserdreservationtable">
								<thead>
									<tr>
										<th>출발지</th>
										<th>도착지</th>
										<th>출발시간</th>
										<th>도착시간</th>
										<th>예약시간</th>
										<th>좌석 번호</th>
										<th>총 금액</th>
										<th style="display: none; width: 0%;">결제 번호</th>
										<th style="display: none; width: 0%;">출발지 ID</th>
										<th style="display: none; width: 0%;">도착지 ID</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="res : ${ReservationNotUsedList}" class="clickable-row" data-toggle="modal"
										data-target="#reservationModal" data-reservation-id="${res.id}" style="cursor: pointer;">
										<td th:text="${res.departureTerminalName}">출발지</td>
										<td th:text="${res.arrivalTerminalName}">도착지</td>
										<td th:text="${#strings.substring(res.departureTime,0,16)}">출발시간</td>
										<td th:text="${#strings.substring(res.arrivalTime,0,16)}">도착시간</td>
										<td th:text="${#strings.substring(res.resDate,0,16)}">예약시간</td>
										<td th:text="${res.seatIds}">좌석 번호</td>
										<td th:text="${res.totalPrice}">총 금액</td>
										<td style="display: none; width: 0%;" th:text="${res.payId}">결제 번호</td>
										<td style="display: none; width: 0%;" th:text="${res.departureTerminalId}">출발지 ID</td>
										<td style="display: none; width: 0%;" th:text="${res.arrivalTerminalId}">출발지 ID</td>
									</tr>
								</tbody>
							</table>

						</div>
						<div th:if="${#lists.isEmpty(ReservationNotUsedList)}">
							<p>현재 예매 중인 상품이 없습니다.</p>
						</div>
					</div>

					<!--예매 내역 조회-->
					<div class="tab-pane fade" id="myreview" role="tabpanel" aria-labelledby="myreview-tab">
						<h3 class="mt-4">전체 예매 내역</h3>
						<div th:if="${not #lists.isEmpty(ReservationList)}">

							<table class="table table-hover table-bordered" id="totalreservationtable">
								<thead>
									<tr>
										<th>출발지</th>
										<th>도착지</th>
										<th>출발시간</th>
										<th>도착시간</th>
										<th>예약시간</th>
										<th>좌석 번호</th>
										<th>결제 번호</th>
										<th>총 금액</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="res : ${ReservationList}">
										<td th:text="${res.departureTerminalName}">출발지</td>
										<td th:text="${res.arrivalTerminalName}">도착지</td>
										<td th:text="${res.departureTime}">출발시간</td>
										<td th:text="${res.arrivalTime}">도착시간</td>
										<td th:text="${res.resDate}">예약시간</td>
										<td th:text="${res.seatIds}">좌석 번호</td>
										<td th:text="${res.payId}">결제 번호</td>
										<td th:text="${res.totalPrice}">총 금액</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div th:if="${#lists.isEmpty(ReservationList)}">
							<p>예매한 내역이 없습니다.</p>
						</div>
					</div>
					<div class="tab-pane fade" id="wishlist" role="tabpanel" aria-labelledby="wishlist-tab">
						<h3 class="mt-4">예매 취소 내역</h3>
						<div th:if="${not #lists.isEmpty(cancelReservationList)}">
							<table class="table table-hover table-bordered" id="cancelreservationtable">
								<thead>
									<tr>
										<th>출발지</th>
										<th>도착지</th>
										<th>출발시간</th>
										<th>도착시간</th>
										<th>예약시간</th>
										<th>좌석 번호</th>
										<th>결제 번호</th>
										<th>총 금액</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="can : ${cancelReservationList}">
										<td th:text="${can.departureTerminalName}">출발지</td>
										<td th:text="${can.arrivalTerminalName}">도착지</td>
										<td th:text="${can.departureTime}">출발시간</td>
										<td th:text="${can.arrivalTime}">도착시간</td>
										<td th:text="${can.resDate}">예약시간</td>
										<td th:text="${can.seatIds}">좌석 번호</td>
										<td th:text="${can.payId}">결제 번호</td>
										<td th:text="${can.totalPrice}">총 금액</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div th:if="${#lists.isEmpty(cancelReservationList)}">
							<p>취소한 내역이 없습니다.</p>
						</div>
					</div>
				</div>

			</div>
		</section>
		<!-- END Section with four info areas left & one card right with image and waves -->
		<!-- -------- START Features w/ pattern background & stats & rocket -------- -->
		<section class="pb-5 position-relative bg-gradient-dark mx-n3">
			<div class="container">
				<div id="mil" class="row">
					<div class="col-md-8 text-start mb-5 mt-5" id="mi">
						<h3 class="text-white z-index-1 position-relative">개인정보 조회</h3>
					</div>
				</div>
				<div class="row">
					<div class="card card-profile ">
						<div class="card-body ps-lg-0">
							<h5 class="mb-0">Emma Roberts</h5>
							<h6 class="text-info">UI Designer</h6>
							<p class="mb-0">Artist is a term applied to a person who engages in an activity deemed to be an art.
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- -------- END Features w/ pattern background & stats & rocket -------- -->

	</div>


	<div class="modal fade" id="reservationModal" tabindex="-1" role="dialog" aria-labelledby="reservationModalLabel"
		aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="reservationModalLabel">예약 상세 정보</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- 모달 내용을 표시할 위치 -->
					<div>
						<p>출발지: <span id="modalDepartureTerminal"></span></p>
						<p>도착지: <span id="modalArrivalTerminal"></span></p>
						<p>출발시간: <span id="modalDepartureTime"></span></p>
						<p>도착시간: <span id="modalArrivalTime"></span></p>
						<p>예약시간: <span id="modalResDate"></span></p>
						<p>좌석 번호: <span id="modalSeatIds"></span></p>
						<p>총 금액: <span id="modalTotalPrice"></span></p>
						<p>결제 번호: <span id="modalPayId"></span></p>
						<p>출발 ID: <span id="modaldepartureTerminalId"></span></p>
						<p>도착 ID: <span id="modalarrivalTerminalId"></span></p>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">닫기</button>
					<button type="button" class="btn bg-gradient-primary">저장</button>
					<button type="button" class="btn btn-danger" id="deleteButton">삭제</button>
					<button type="button" class="btn bg-gradient-primary" id='changeSeat'>좌석변경</button>

				</div>
			</div>
		</div>
	</div>

	<div th:replace="~{fragments/footerFragment :: footer}"></div>

	<!--   Core JS Files   -->
	<script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
	<script src="../assets/js/core/bootstrap.min.js" type="text/javascript"></script>
	<script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
	<!--  Plugin for TypedJS, full documentation here: https://github.com/inorganik/CountUp.js -->
	<script src="../assets/js/plugins/countup.min.js"></script>
	<!-- Control Center for Material UI Kit: parallax effects, scripts for the example pages etc -->
	<!--  Google Maps Plugin    -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTTfWur0PDbZWPr7Pmq8K3jiDp0_xUziI"></script>
	<script src="../assets/js/material-kit.min.js?v=3.0.4" type="text/javascript"></script>
	
	<!--sweetalert2-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>

	<script>
		var inputData;
		var depPlaceNm;
		var arrPlaceNm;
		var depTime;
		var paymentId;

		$('.clickable-row').click(function () {
			var departureTerminal = $(this).find('td:eq(0)').text();
			var arrivalTerminal = $(this).find('td:eq(1)').text();
			var departureTime = $(this).find('td:eq(2)').text().substring(0,16);
			var arrivalTime = $(this).find('td:eq(3)').text().substring(0,16);
			var resDate = $(this).find('td:eq(4)').text();
			var seatIds = $(this).find('td:eq(5)').text();
			var totalPrice = $(this).find('td:eq(6)').text();
			var payId = $(this).find('td:eq(7)').text();
			var departureTerminalId = $(this).find('td:eq(8)').text();
			var arrivalTerminalId = $(this).find('td:eq(9)').text();
			paymentId = payId;
			depPlaceNm =  departureTerminal;
			arrPlaceNm =  arrivalTerminal;
			depTime =  encodeURIComponent(departureTime);
			console.log(depTime);
			inputData = {"payId": payId, "totalPrice": totalPrice};
			console.log(depPlaceNm);
			// 모달에 데이터 넣기
			$('#modalDepartureTerminal').text(departureTerminal);
			$('#modalArrivalTerminal').text(arrivalTerminal);
			$('#modalDepartureTime').text(departureTime);
			$('#modalArrivalTime').text(arrivalTime);
			$('#modalResDate').text(resDate);
			$('#modalSeatIds').text(seatIds);
			$('#modalTotalPrice').text(totalPrice);
			$('#modalPayId').text(payId);
			$('#modaldepartureTerminalId').text(departureTerminalId);
			$('#modalarrivalTerminalId').text(arrivalTerminalId);

			// 모달 열기
			$('#reservationModal').modal('show');
		});
		//var seatURI = '/reservation/seat-selection?dpTerminalName='+ depPlaceNm + 'arrTerminalName=' +arrPlaceNm+ 'departureTime=' + depTime;
		//var seatURI = "/reservation/seat-selection?dpTerminalName=";
		$("#changeSeat").click(function () {
			var seatURI = '/reservation/seats-selection/modification/?dpTerminalName='+ depPlaceNm + 
			'&arrTerminalName=' +arrPlaceNm+ '&departureTime=' + depTime +'&payId=' +paymentId;

			console.log(depPlaceNm);
			window.location.href = seatURI;
			//window.location.href = "/"
		});
		$("#deleteButton").click(function () {
			// SweetAlert2가 나타날 때 모달 숨기기
			$("#reservationModal").modal('hide');

			Swal.fire({
				title: '예매를 취소하시겠습니까?',
				text: "한번 취소한 예매는 다시 되돌릴 수 없습니다.",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: '승인',
				cancelButtonText: '취소',
				reverseButtons: true, // 버튼 순서 거꾸로
			}).then((result) => {
				if (result.isConfirmed) {

					$.ajax({
						url: '/cancelReservation',
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(inputData),
						success: function (response) {
							// 서버 응답에 대한 처리
							console.log(response);

							// SweetAlert2를 다시 표시
							Swal.fire({
								title: '취소가 완료되었습니다.',
								icon: 'success',
								confirmButtonText: '확인',
							}).then((result) => {
								if (result.isConfirmed) {
									location.href("/mypage");
								}
							});
						},
						error: function (error) {
							// 오류 발생 시 처리
							console.error(error);

							// 오류가 발생했을 때도 SweetAlert2를 다시 표시
							Swal.fire({
								title: '취소에 실패하였습니다.',
								text: '',
								icon: 'success',
								confirmButtonText: '확인',
							}).then(() => {
								location.href("/");
							});
						}
					});
				} else if (result.isDismissed && result.dismiss === Swal.DismissReason.cancel) {
					// SweetAlert2에서 "취소" 버튼 클릭 시 모달 다시 표시
					$("#reservationModal").modal('show');
				}
			});
		});

	</script>

	<!--<script>
    // 클릭한 행의 데이터를 모달에 표시하는 JavaScript 코드
    $('.clickable-row').click(function() {
        var modalContent = $(this).html();
        $('#modalContent').html(modalContent);
        $('#reservationModal').modal('show');
    });
</script>-->
	<script>
	</script>
	<script>
		// get the element to animate
		var element = document.getElementById('count-stats');
		var elementHeight = element.clientHeight;

		// listen for scroll event and call animate function

		document.addEventListener('scroll', animate);

		// check if element is in view
		function inView() {
			// get window height
			var windowHeight = window.innerHeight;
			// get number of pixels that the document is scrolled
			var scrollY = window.scrollY || window.pageYOffset;
			// get current scroll position (distance from the top of the page to the bottom of the current viewport)
			var scrollPosition = scrollY + windowHeight;
			// get element position (distance from the top of the page to the bottom of the element)
			var elementPosition = element.getBoundingClientRect().top + scrollY + elementHeight;

			// is scroll position greater than element position? (is element in view?)
			if (scrollPosition > elementPosition) {
				return true;
			}

			return false;
		}

		var animateComplete = true;
		// animate element when it is in view
		function animate() {

			// is element in view?
			if (inView()) {
				if (animateComplete) {
					if (document.getElementById('state1')) {
						const countUp = new CountUp('state1', document.getElementById("state1").getAttribute("countTo"));
						if (!countUp.error) {
							countUp.start();
						} else {
							console.error(countUp.error);
						}
					}
					if (document.getElementById('state2')) {
						const countUp1 = new CountUp('state2', document.getElementById("state2").getAttribute("countTo"));
						if (!countUp1.error) {
							countUp1.start();
						} else {
							console.error(countUp1.error);
						}
					}
					if (document.getElementById('state3')) {
						const countUp2 = new CountUp('state3', document.getElementById("state3").getAttribute("countTo"));
						if (!countUp2.error) {
							countUp2.start();
						} else {
							console.error(countUp2.error);
						};
					}
					animateComplete = false;
				}
			}
		}

		if (document.getElementById('typed')) {
			var typed = new Typed("#typed", {
				stringsElement: '#typed-strings',
				typeSpeed: 90,
				backSpeed: 90,
				backDelay: 200,
				startDelay: 500,
				loop: true
			});
		}
	</script>
	<script>
		if (document.getElementsByClassName('page-header')) {
			window.onscroll = debounce(function () {
				var scrollPosition = window.pageYOffset;
				var bgParallax = document.querySelector('.page-header');
				var oVal = (window.scrollY / 3);
				bgParallax.style.transform = 'translate3d(0,' + oVal + 'px,0)';
			}, 6);
		}
	</script>
</body>

</html>